// ==========================================================================
// Project:   SproutCore - JavaScript Application Framework
// Copyright: ©2006-2011 Strobe Inc. and contributors.
//            Portions ©2008-2011 Apple Inc. All rights reserved.
// License:   Licensed under MIT license (see license.js)
// ==========================================================================

(function(a){SC.handleActions=function(a){var b=Array.prototype.slice.call(arguments);return b.shift(),a.isActionHandler=YES,a.actions=b,a},SC.stateObserves=function(a){var b=Array.prototype.slice.call(arguments);return b.shift(),a.isStateObserveHandler=YES,a.args=b,a}})({}),function(a){SC.StatechartSequenceMatcher=SC.Object.extend({statechartMonitor:null,match:null,MISMATCH:{},begin:function(){return this._stack=[],this.beginSequence(),this._start=this._stack[0],this},end:function(){this.endSequence();if(this._stack.length>0)throw"can not match sequence. sequence matcher has been left in an invalid state";var a=this.statechartMonitor,b=this._matchSequence(this._start,0)===a.sequence.length;return this.set("match",b),b},entered:function(){return this._addStatesToCurrentGroup("entered",arguments),this},exited:function(){return this._addStatesToCurrentGroup("exited",arguments),this},beginConcurrent:function(){var a={type:"concurrent",values:[]};return this._peek()&&this._peek().values.push(a),this._stack.push(a),this},endConcurrent:function(){return this._stack.pop(),this},beginSequence:function(){var a={type:"sequence",values:[]};return this._peek()&&this._peek().values.push(a),this._stack.push(a),this},endSequence:function(){return this._stack.pop(),this},_peek:function(){var a=this._stack.length;return a===0?null:this._stack[a-1]},_addStatesToCurrentGroup:function(a,b){var c=this._peek(),d=b.length,e=0;for(;e<d;e+=1)c.values.push({action:a,state:b[e]})},_matchSequence:function(a,b){var c=a.values,d=c.length,e=0,f,g=this.statechartMonitor;if(d===0)return b;if(b>g.sequence.length)return this.MISMATCH;for(;e<d;e+=1){f=c[e];if(f.type==="sequence")b=this._matchSequence(f,b);else if(f.type==="concurrent")b=this._matchConcurrent(f,b);else{if(!this._matchItems(f,g.sequence[b]))return this.MISMATCH;b+=1}if(b===this.MISMATCH)return this.MISMATCH}return b},_matchConcurrent:function(a,b){var c=a.values.slice(0),d=c.length,e=0,f,g=b,h=!1,i=this.statechartMonitor;if(d===0)return b;if(b>i.sequence.length)return this.MISMATCH;while(c.length>0){for(e=0;e<d;e+=1){f=c[e],f.type==="sequence"?g=this._matchSequence(f,b):f.type==="concurrent"?g=this._matchConcurrent(f,b):this._matchItems(f,i.sequence[b])?g=b+1:g=this.MISMATCH;if(g!==this.MISMATCH)break}if(g===this.MISMATCH)return this.MISMATCH;c.removeAt(e),d=c.length,b=g}return b},_matchItems:function(a,b){return!a||!b?!1:a.action!==b.action?!1:SC.typeOf(a.state)==="instance"&&a.state===b.state?!0:a.state===b.state.get("stateName")?!0:!1}})}({}),function(a){SC.StatechartMonitor=SC.Object.extend({statechart:null,sequence:null,init:function(){this.reset()},reset:function(){this.propertyWillChange("length"),this.sequence=[],this.propertyDidChange("length")},length:function(){return this.sequence.length}.property(),pushEnteredState:function(a){this.propertyWillChange("length"),this.sequence.push({action:"entered",state:a}),this.propertyDidChange("length")},pushExitedState:function(a){this.propertyWillChange("length"),this.sequence.push({action:"exited",state:a}),this.propertyDidChange("length")},matchSequence:function(){return SC.StatechartSequenceMatcher.create({statechartMonitor:this})},matchEnteredStates:function(){var a=Array.prototype.slice.call(arguments.length===1?arguments[0]:arguments),b=this.getPath("statechart.enteredStates"),c=0,d=this.get("statechart");return a.length!==b.length?NO:(a.forEach(function(a){SC.typeOf(a)==="string"&&(a=d.getState(a));if(!a)return;d.stateIsEntered(a)&&a.get("isEnteredState")&&(c+=1)}),c===b.length)},toString:function(){var a="",b=0,c=0,d=null;a+="[",c=this.sequence.length;for(b=0;b<c;b+=1)d=this.sequence[b],a+="%@ %@".fmt(d.action,d.state.get("fullPath")),b<c-1&&(a+=", ");return a+="]",a}})}({}),function(a){}({}),function(a){SC.EXTEND_PROTOTYPES&&(Function.prototype.handleActions=function(){var a=Array.prototype.slice.call(arguments);return a.unshift(this),SC.handleActions.apply(SC,a)},Function.prototype.stateObserves=function(){var a=Array.prototype.slice.call(arguments);return a.unshift(this),SC.stateObserves.apply(SC,a)})}({}),function(a){}({}),function(a){SC.Async=SC.Object.extend({func:null,arg1:null,arg2:null,tryToPerform:function(a){var b=this.get("func"),c=this.get("arg1"),d=this.get("arg2"),e=SC.typeOf(b);e==="string"?SC.tryToPerform(a,b,c,d):e==="function"&&b.apply(a,[c,d])}}),SC.Async.reopenClass({perform:function(a,b,c){return SC.Async.create({func:a,arg1:b,arg2:c})}})}({}),function(a){var b=SC.get,c=SC.set,d=SC.getPath,e=Array.prototype.slice;SC.State=SC.Object.extend({stateName:null,parentState:null,historyState:null,initialSubstate:null,substatesAreConcurrent:!1,substates:null,statechart:null,stateIsInitialized:!1,currentSubstates:null,enteredSubstates:null,trace:function(){var a=d(this,"statechart.statechartTraceKey");return d(this,"statechart.%@".fmt(a))}.property().cacheable(),owner:function(){var a=b(this,"statechart"),c=a?b(a,"statechartOwnerKey"):null,d=a?b(a,c):null;return d?d:a}.property().cacheable(),init:function(){this._registeredActionHandlers={},this._registeredStringActionHandlers={},this._registeredRegExpActionHandlers=[],this._registeredStateObserveHandlers={};var a=b(this,"statechart"),c=a?b(a,"statechartOwnerKey"):null,d=a?b(a,"statechartTraceKey"):null;a&&(a.addObserver(c,this,"_statechartOwnerDidChange"),a.addObserver(d,this,"_statechartTraceDidChange"))},destroy:function(){var a=b(this,"statechart"),d=a?b(a,"statechartOwnerKey"):null,e=a?b(a,"statechartTraceKey"):null;a&&(SC.removeObserver(a,d,this,"_statechartOwnerDidChange"),SC.removeObserver(a,e,this,"_statechartTraceDidChange"));var f=b(this,"substates");f&&f.forEach(function(a){a.destroy()}),this._teardownAllStateObserveHandlers(),c(this,"substates",null),c(this,"currentSubstates",null),c(this,"enteredSubstates",null),c(this,"parentState",null),c(this,"historyState",null),c(this,"initialSubstate",null),c(this,"statechart",null),this.notifyPropertyChange("trace"),this.notifyPropertyChange("owner"),this._registeredActionHandlers=null,this._registeredStringActionHandlers=null,this._registeredRegExpActionHandlers=null,this._registeredStateObserveHandlers=null,this._super()},initState:function(){if(b(this,"stateIsInitialized"))return;this._registerWithParentStates();var a=null,d=null,e=null,f=[],g=NO,h=b(this,"initialSubstate"),i=b(this,"substatesAreConcurrent"),j=b(this,"statechart"),k=0,l=0,m=NO,n=null;SC.HistoryState.detect(h)&&h.isClass&&(n=this.createHistoryState(h,{parentState:this,statechart:j}),c(this,"initialSubstate",n),SC.none(b(n,"defaultState"))&&(this.stateLogError("Initial substate is invalid. History state requires the name of a default state to be set"),c(this,"initialSubstate",null),n=null));for(a in this){d=this[a],m=SC.typeOf(d)==="function";if(m&&d.isActionHandler){this._registerActionHandler(a,d);continue}if(m&&d.isStateObserveHandler){this._registerStateObserveHandler(a,d);continue}m&&d.statePlugin&&(d=d.apply(this)),SC.State.detect(d)&&d.isClass&&this[a]!==this.constructor&&(e=this.createSubstate(d,{stateName:a,parentState:this,statechart:j}),f.push(e),this[a]=e,e.initState(),a===h?(c(this,"initialSubstate",e),g=YES):n&&b(n,"defaultState")===a&&(c(n,"defaultState",e),g=YES))}!SC.none(h)&&!g&&this.stateLogError("Unable to set initial substate %@ since it did not match any of state's %@ substates".fmt(h,this)),f.length===0?SC.none(h)||this.stateLogWarning("Unable to make %@ an initial substate since state %@ has no substates".fmt(h,this)):f.length>0&&(SC.none(h)&&!i?(e=this.createEmptyState({parentState:this,statechart:j}),c(this,"initialSubstate",e),f.push(e),this[b(e,"stateName")]=e,e.initState(),this.stateLogWarning("state %@ has no initial substate defined. Will default to using an empty state as initial substate".fmt(this))):!SC.none(h)&&i&&(c(this,"initialSubstate",null),this.stateLogWarning("Can not use %@ as initial substate since substates are all concurrent for state %@".fmt(h,this)))),c(this,"substates",f),c(this,"currentSubstates",[]),c(this,"enteredSubstates",[]),c(this,"stateIsInitialized",YES)},createSubstate:function(a,b){return a.create(b)},createHistoryState:function(a,b){return a.create(b)},createEmptyState:function(a){return SC.EmptyState.create(a)},_registerActionHandler:function(a,b){var c=b.actions,d=null,e=c.length,f=0;this._registeredActionHandlers[a]=b;for(;f<e;f+=1){d=c[f];if(SC.typeOf(d)==="string"){this._registeredStringActionHandlers[d]={name:a,handler:b};continue}if(d instanceof RegExp){this._registeredRegExpActionHandlers.push({name:a,handler:b,regexp:d});continue}this.stateLogError("Invalid action %@ for action handler %@ in state %@".fmt(d,a,this))}},_registerStateObserveHandler:function(a,b){var c=0,d=b.args,e=d.length,f,g=YES;for(;c<e;c+=1){f=d[c];if(SC.typeOf(f)!=="string"||SC.empty(f))this.stateLogError("Invalid argument %@ for state observe handler %@ in state %@".fmt(f,a,this)),g=NO}if(!g)return;this._registeredStateObserveHandlers[a]=b.args},_registerWithParentStates:function(){this._registerSubstate(this);var a=b(this,"parentState");while(!SC.none(a))a._registerSubstate(this),a=b(a,"parentState")},_registerSubstate:function(a){var c=a.pathRelativeTo(this);if(SC.none(c))return;SC.none(this._registeredSubstatePaths)&&(this._registeredSubstatePaths={},this._registeredSubstates=[]),this._registeredSubstates.push(a);var d=this._registeredSubstatePaths;d[b(a,"stateName")]===undefined&&(d[b(a,"stateName")]={__ki_paths__:[]});var e=d[b(a,"stateName")];e[c]=a,e.__ki_paths__.push(c)},pathRelativeTo:function(a){var c=b(this,"stateName"),d=b(this,"parentState");while(!SC.none(d)&&d!==a)c="%@.%@".fmt(b(d,"stateName"),c),d=b(d,"parentState");return d!==a&&a!==this?(this.stateLogError("Can not generate relative path from %@ since it not a parent state of %@".fmt(a,this)),null):c},getSubstate:function(a){var b=SC.typeOf(a);if(a instanceof SC.State)return this._registeredSubstates.indexOf(a)>-1?a:null;if(b!=="string")return this.stateLogError("Can not find matching subtype. value must be an object or string: %@".fmt(a)),null;var c=a.match(/(^|\.)(\w+)$/);if(!c)return null;var d=this._registeredSubstatePaths[c[2]];if(SC.none(d))return null;var e=d[a];if(!SC.none(e))return e;if(c[1]==="")if(d.__ki_paths__.length===1)e=d[d.__ki_paths__[0]];else if(d.__ki_paths__.length>1){var f="Can not find substate matching %@ in state %@. Ambiguous with the following: %@";this.stateLogError(f.fmt(a,this,d.__ki_paths__))}return e},gotoState:function(a,c){var d=null;b(this,"isCurrentState")?d=this:b(this,"hasCurrentSubstates")&&(d=b(this,"currentSubstates")[0]),b(this,"statechart").gotoState(a,d,c)},gotoHistoryState:function(a,c,d){var e=null;b(this,"isCurrentState")?e=this:b(this,"hasCurrentSubstates")&&(e=b(this,"currentSubstates")[0]),b(this,"statechart").gotoHistoryState(a,e,c,d)},resumeGotoState:function(){b(this,"statechart").resumeGotoState()},stateIsCurrentSubstate:function(a){SC.typeOf(a)==="string"&&(a=b(this,"statechart").getState(a));var c=b(this,"currentSubstates");return!!c&&c.indexOf(a)>=0},stateIsEnteredSubstate:function(a){SC.typeOf(a)==="string"&&(a=b(this,"statechart").getState(a));var c=b(this,"enteredSubstates");return!!c&&c.indexOf(a)>=0},isRootState:function(){return d(this,"statechart.rootState")===this}.property(),isCurrentState:function(){return this.stateIsCurrentSubstate(this)}.property("currentSubstates").cacheable(),isConcurrentState:function(){return d(this,"parentState.substatesAreConcurrent")}.property(),isEnteredState:function(){return this.stateIsEnteredSubstate(this)}.property("enteredSubstates").cacheable(),hasSubstates:function(){return d(this,"substates.length")>0}.property("substates"),hasCurrentSubstates:function(){var a=b(this,"currentSubstates");return!!a&&b(a,"length")>0}.property("currentSubstates").cacheable(),hasEnteredSubstates:function(){var a=b(this,"enteredSubstates");return!!a&&b(a,"length")>0}.property("enteredSubstates").cacheable(),reenter:function(){var a=b(this,"statechart");b(this,"isCurrentState")?a.gotoState(this):SC.Logger.error("Can not re-enter state %@ since it is not a current state in the statechart".fmt(this))},tryToHandleAction:function(a,c,d){var e=b(this,"trace");if(this._registeredActionHandlers[a])return this.stateLogWarning("state %@ can not handle action %@ since it is a registered action handler".fmt(this,a)),NO;if(this._registeredStateObserveHandlers[a])return this.stateLogWarning("state %@ can not handle action %@ since it is a registered state observe handler".fmt(this,a)),NO;if(SC.typeOf(this[a])==="function")return e&&this.stateLogTrace("will handle action %@".fmt(a)),this[a](c,d)!==NO;var f=this._registeredStringActionHandlers[a];if(f)return e&&this.stateLogTrace("%@ will handle action %@".fmt(f.name,a)),f.handler.call(this,a,c,d)!==NO;var g=this._registeredRegExpActionHandlers.length,h=0;for(;h<g;h+=1){f=this._registeredRegExpActionHandlers[h];if(a.match(f.regexp))return e&&this.stateLogTrace("%@ will handle action %@".fmt(f.name,a)),f.handler.call(this,a,c,d)!==NO}return SC.typeOf(this.unknownAction)==="function"?(e&&this.stateLogTrace("unknownAction will handle action %@".fmt(a)),this.unknownAction(a,c,d)!==NO):NO},enterState:function(a){},stateWillBecomeEntered:function(){},stateDidBecomeEntered:function(){this._setupAllStateObserveHandlers()},exitState:function(a){},stateWillBecomeExited:function(){this._teardownAllStateObserveHandlers()},stateDidBecomeExited:function(){},_setupAllStateObserveHandlers:function(){this._configureAllStateObserveHandlers("addObserver")},_teardownAllStateObserveHandlers:function(){this._configureAllStateObserveHandlers("removeObserver")},_configureAllStateObserveHandlers:function(a){var b,c,d,e,f,g;for(b in this._registeredStateObserveHandlers){c=this._registeredStateObserveHandlers[b];for(f=0;f<c.length;f+=1)d=c[f],e=b,g=SC.normalizeTuple(this,d),SC[a](g[0],g[1],this,e)}},performAsync:function(a,b,c){return SC.Async.perform(a,b,c)},respondsToAction:function(a){if(this._registeredActionHandlers[a])return!1;if(SC.typeOf(this[a])==="function")return!0;if(this._registeredStringActionHandlers[a])return!0;if(this._registeredStateObserveHandlers[a])return!1;var b=this._registeredRegExpActionHandlers.length,c=0,d;for(;c<b;c+=1){d=this._registeredRegExpActionHandlers[c];if(a.match(d.regexp))return!0}return SC.typeOf(this.unknownAction)==="function"},fullPath:function(){var a=d(this,"statechart.rootState");return a?this.pathRelativeTo(a):b(this,"stateName")}.property("stateName","parentState").cacheable(),_statechartTraceDidChange:function(){this.notifyPropertyChange("trace")},_statechartOwnerDidChange:function(){this.notifyPropertyChange("owner")},stateLogTrace:function(a){var c=b(this,"statechart");c.statechartLogTrace("%@: %@".fmt(this,a))},stateLogWarning:function(a){var c=b(this,"statechart");c.statechartLogWarning(a)},stateLogError:function(a){var c=b(this,"statechart");c.statechartLogError(a)}}),SC.State.plugin=function(a){var b=e.call(arguments);b.shift();var c=function(){var c=SC.getPath(window,a);return c?!c.isClass||c.isInstance&&!(c instanceof SC.State)?(console.error("SC.State.plugin: Unable to extend. %@ must be a class extending from SC.State".fmt(a)),undefined):c.extend.apply(c,b):(console.error("SC.State.plugin: Unable to determine path %@".fmt(a)),undefined)};return c.statePlugin=YES,c}}({}),function(a){SC.EMPTY_STATE_NAME="__EMPTY_STATE__",SC.EmptyState=SC.State.extend({name:SC.EMPTY_STATE_NAME,enterState:function(){var a="No initial substate was defined for state %@. Entering default empty state";this.stateLogWarning(a.fmt(this.get("parentState")))}})}({}),function(a){SC.HistoryState=SC.Object.extend({isRecursive:NO,defaultState:null,statechart:null,parentState:null,state:function(){var a=this.get("defaultState"),b=this.getPath("parentState.historyState");return b?b:a}.property().cacheable(),parentHistoryStateDidChange:function(){this.notifyPropertyChange("state")}.observes("*parentState.historyState")})}({}),function(a){var b=SC.get,c=SC.set,d=SC.getPath;SC.StatechartManager={isStatechart:!0,statechartIsInitialized:!1,rootState:null,rootStateExample:SC.State,initialState:null,statesAreConcurrent:!1,monitorIsActive:!1,monitor:null,statechartTraceKey:"trace",trace:!1,statechartOwnerKey:"owner",owner:null,autoInitStatechart:!0,suppressStatechartWarnings:!1,init:function(){b(this,"autoInitStatechart")&&this.initStatechart()},destroy:function(){var a=b(this,"rootState"),d=b(this,"statechartTraceKey");SC.removeObserver(this,d,this,"_statechartTraceDidChange"),a.destroy(),c(this,"rootState",null),this._super()},initStatechart:function(){if(b(this,"statechartIsInitialized"))return;this._gotoStateLocked=!1,this._sendActionLocked=!1,this._pendingStateTransitions=[],this._pendingSentActions=[],b(this,"monitorIsActive")&&c(this,"monitor",SC.StatechartMonitor.create({statechart:this}));var a=b(this,"statechartTraceKey");this.addObserver(a,this,"_statechartTraceDidChange"),this._statechartTraceDidChange();var d=b(this,"allowStatechartTracing"),e=b(this,"rootState"),f;d&&this.statechartLogTrace("BEGIN initialize statechart"),e?SC.typeOf(e)==="function"&&e.statePlugin&&(e=e.apply(this)):e=this._constructRootStateClass();if(!SC.State.detect(e)||!e.isClass)throw f="Unable to initialize statechart. Root state must be a state class",this.statechartLogError(f),f;e=this.createRootState(e,{statechart:this,stateName:SC.ROOT_STATE_NAME}),c(this,"rootState",e),e.initState();if(SC.EmptyState.detect(b(e,"initialSubstate")))throw f="Unable to initialize statechart. Root state must have an initial substate explicilty defined",this.statechartLogError(f),f;if(!SC.empty(b(this,"initialState"))){var g="initialState";c(this,g,b(e,b(this,g)))}c(this,"statechartIsInitialized",!0),this.gotoState(e),d&&this.statechartLogTrace("END initialize statechart")},createRootState:function(a,b){return b||(b={}),a=a.create(b),a},currentStates:function(){return d(this,"rootState.currentSubstates")}.property().cacheable(),firstCurrentState:function(){var a=b(this,"currentStates");return a?a.objectAt(0):null}.property("currentStates").cacheable(),currentStateCount:function(){return d(this,"currentStates.length")}.property("currentStates").cacheable(),stateIsCurrentState:function(a){return b(this,"rootState").stateIsCurrentSubstate(a)},enteredStates:function(){return d(this,"rootState.enteredSubstates")}.property().cacheable(),stateIsEntered:function(a){return b(this,"rootState").stateIsEnteredSubstate(a)},doesContainState:function(a){return!SC.none(this.getState(a))},getState:function(a){return b(this,"rootState").getSubstate(a)},gotoState:function(a,c,e,f){if(!b(this,"statechartIsInitialized")){this.statechartLogError("can not go to state %@. statechart has not yet been initialized".fmt(a));return}if(b(this,"isDestroyed")){this.statechartLogError("can not go to state %@. statechart is destroyed".fmt(this));return}var g=this._processGotoStateArgs(arguments);a=g.state,c=g.fromCurrentState,e=g.useHistory,f=g.context;var h=null,i=[],j=[],k=b(this,"allowStatechartTracing"),l=b(this,"rootState"),m=a,n=c,o,p=l.getSubstate(a);if(SC.none(p)){this.statechartLogError("Can not to goto state %@. Not a recognized state in statechart".fmt(m));return}if(this._gotoStateLocked){this._pendingStateTransitions.push({state:p,fromCurrentState:c,useHistory:e,context:f});return}this._gotoStateLocked=!0;if(!SC.none(c)){c=l.getSubstate(c);if(SC.none(c)||!b(c,"isCurrentState")){o="Can not to goto state %@. %@ is not a recognized current state in statechart",this.statechartLogError(o.fmt(m,n)),this._gotoStateLocked=!1;return}}else d(this,"currentStates.length")>0&&(c=b(this,"currentStates")[0],o="gotoState: fromCurrentState not explicitly provided. Using a default current state to transition from: %@",this.statechartLogWarning(o.fmt(c)));k&&(this.statechartLogTrace("BEGIN gotoState: %@".fmt(p)),o="starting from current state: %@",o=o.fmt(c?c:"---"),this.statechartLogTrace(o),o="current states before: %@",o=o.fmt(d(this,"currentStates.length")>0?b(this,"currentStates"):"---"),this.statechartLogTrace(o)),SC.none(c)||(i=this._createStateChain(c)),j=this._createStateChain(p),h=this._findPivotState(i,j);if(h){k&&this.statechartLogTrace("pivot state = %@".fmt(h));if(b(h,"substatesAreConcurrent")){this.statechartLogError("Can not go to state %@ from %@. Pivot state %@ has concurrent substates.".fmt(p,c,h)),this._gotoStateLocked=!1;return}}var q=[];this._traverseStatesToExit(i.shift(),i,h,q),h!==p?this._traverseStatesToEnter(j.pop(),j,h,e,q):(this._traverseStatesToExit(h,[],null,q),this._traverseStatesToEnter(h,null,null,e,q)),this._executeGotoStateActions(p,q,null,f)},gotoStateActive:function(){return this._gotoStateLocked}.property(),gotoStateSuspended:function(){return this._gotoStateLocked&&!!this._gotoStateSuspendedPoint}.property(),resumeGotoState:function(){if(!b(this,"gotoStateSuspended")){this.statechartLogError("Can not resume goto state since it has not been suspended");return}var a=this._gotoStateSuspendedPoint;this._executeGotoStateActions(a.gotoState,a.actions,a.marker,a.context)},_executeGotoStateActions:function(a,c,d,e){var f=null,g=c.length,h=null;d=SC.none(d)?0:d;for(;d<g;d+=1){f=c[d];switch(f.action){case SC.EXIT_STATE:h=this._exitState(f.state,e);break;case SC.ENTER_STATE:h=this._enterState(f.state,f.currentState,e)}if(h instanceof SC.Async){this._gotoStateSuspendedPoint={gotoState:a,actions:c,marker:d+1,context:e},h.tryToPerform(f.state);return}}this.beginPropertyChanges(),this.notifyPropertyChange("currentStates"),this.notifyPropertyChange("enteredStates"),this.endPropertyChanges(),b(this,"allowStatechartTracing")&&(this.statechartLogTrace("current states after: %@".fmt(b(this,"currentStates"))),this.statechartLogTrace("END gotoState: %@".fmt(a))),this._gotoStateSuspendedPoint=null,this._gotoStateLocked=!1,this._flushPendingStateTransition()},_exitState:function(a,d){var e;if(b(a,"currentSubstates").indexOf(a)>=0){e=b(a,"parentState");while(e)b(e,"currentSubstates").removeObject(a),e=b(e,"parentState")}e=a;while(e)b(e,"enteredSubstates").removeObject(a),e=b(e,"parentState");b(this,"allowStatechartTracing")&&this.statechartLogTrace("<-- exiting state: %@".fmt(a)),c(a,"currentSubstates",[]),a.notifyPropertyChange("isCurrentState"),a.stateWillBecomeExited();var f=this.exitState(a,d);return a.stateDidBecomeExited(),b(this,"monitorIsActive")&&b(this,"monitor").pushExitedState(a),a._traverseStatesToExit_skipState=!1,f},exitState:function(a,b){return a.exitState(b)},_enterState:function(a,d,e){var f=b(a,"parentState");f&&!b(a,"isConcurrentState")&&c(f,"historyState",a);if(d){f=a;while(f)b(f,"currentSubstates").pushObject(a),f=b(f,"parentState")}f=a;while(f)b(f,"enteredSubstates").pushObject(a),f=b(f,"parentState");b(this,"allowStatechartTracing")&&this.statechartLogTrace("--> entering state: %@".fmt(a)),a.notifyPropertyChange("isCurrentState"),a.stateWillBecomeEntered();var g=this.enterState(a,e);return a.stateDidBecomeEntered(),b(this,"monitorIsActive")&&b(this,"monitor").pushEnteredState(a),g},enterState:function(a,b){return a.enterState(b)},gotoHistoryState:function(a,c,d,e){if(!b(this,"statechartIsInitialized")){this.statechartLogError("can not go to state %@'s history state. Statechart has not yet been initialized".fmt(a));return}var f=this._processGotoStateArgs(arguments);a=f.state,c=f.fromCurrentState,d=f.useHistory,e=f.context,a=this.getState(a);if(!a){this.statechartLogError("Can not to goto state %@'s history state. Not a recognized state in statechart".fmt(a));return}var g=b(a,"historyState");d?this.gotoState(a,c,!0,e):g?this.gotoState(g,c,e):this.gotoState(a,c,e)},sendAction:function(a,c,d){if(b(this,"isDestroyed")){this.statechartLogError("can send action %@. statechart is destroyed".fmt(a));return}var e=!1,f=!1,g=b(this,"currentStates").slice(),h=0,i=0,j=null,k=b(this,"allowStatechartTracing");if(this._sendActionLocked||this._gotoStateLocked){this._pendingSentActions.push({action:a,arg1:c,arg2:d});return}this._sendActionLocked=!0,k&&this.statechartLogTrace("BEGIN sendAction: action<%@>".fmt(a)),h=b(g,"length");for(;i<h;i+=1){f=!1,j=g[i];if(!b(j,"isCurrentState"))continue;while(!f&&j)f=j.tryToHandleAction(a,c,d),f?e=!0:j=b(j,"parentState")}this._sendActionLocked=!1,k&&(e||this.statechartLogTrace("No state was able handle action %@".fmt(a)),this.statechartLogTrace("END sendAction: action<%@>".fmt(a)));var l=this._flushPendingSentActions();return e?this:l?this:null},_createStateChain:function(a){var c=[];while(a)c.push(a),a=b(a,"parentState");return c},_findPivotState:function(a,b){if(a.length===0||b.length===0)return null;var c=a.find(function(a,c){if(b.indexOf(a)>=0)return!0});return c},_traverseStatesToExit:function(a,c,d,e){if(!a||a===d)return;var f=b(this,"allowStatechartTracing");if(b(a,"substatesAreConcurrent")){var g=0,h=b(a,"currentSubstates"),i=h.length,j=null;for(;g<i;g+=1){j=h[g];if(j._traverseStatesToExit_skipState===!0)continue;var k=this._createStateChain(j);this._traverseStatesToExit(k.shift(),k,a,e)}}e.push({action:SC.EXIT_STATE,state:a}),b(a,"isCurrentState")&&(a._traverseStatesToExit_skipState=!0),this._traverseStatesToExit(c.shift(),c,d,e)},_traverseStatesToEnter:function(a,c,d,e,f){if(!a)return;var g=b(this,"allowStatechartTracing");if(d)a!==d?this._traverseStatesToEnter(c.pop(),c,d,e,f):this._traverseStatesToEnter(c.pop(),c,null,e,f);else if(!c||c.length===0){var h={action:SC.ENTER_STATE,state:a,currentState:!1};f.push(h);var i=b(a,"initialSubstate"),j=b(a,"historyState");b(a,"substatesAreConcurrent")?this._traverseConcurrentStatesToEnter(b(a,"substates"),null,e,f):b(a,"hasSubstates")&&j&&e?this._traverseStatesToEnter(j,null,null,e,f):i?(i instanceof SC.HistoryState&&(e||(e=b(i,"isRecursive")),i=b(i,"state")),this._traverseStatesToEnter(i,null,null,e,f)):h.currentState=!0}else if(c.length>0){f.push({action:SC.ENTER_STATE,state:a});var k=c.pop();this._traverseStatesToEnter(k,c,null,e,f),b(a,"substatesAreConcurrent")&&this._traverseConcurrentStatesToEnter(b(a,"substates"),k,e,f)}},respondsTo:function(a){var c=b(this,"currentStates"),d=b(c,"length"),e=0,f=null;for(;e<d;e+=1){f=c.objectAt(e);while(f){if(f.respondsToAction(a))return!0;f=b(f,"parentState")}}return SC.typeOf(this[a])==="function"},tryToPerform:function(a,b,c){return this.respondsTo(a)?SC.typeOf(this[a])==="function"?this[a](b,c)!==!1:!!this.sendAction(a,b,c):!1},invokeStateMethod:function(a,c,d){if(a==="unknownAction"){this.statechartLogError("can not invoke method unkownAction");return}c=Array.prototype.slice.call(arguments),c.shift();var e=c.length,f=e>0?c[e-1]:null,g=SC.typeOf(f)==="function"?c.pop():null,h=b(this,"currentStates"),i=0,j=null,k={},l,m=undefined,n=0;e=b(h,"length");for(;i<e;i+=1){j=h.objectAt(i);while(j){if(k[b(j,"fullPath")])break;k[b(j,"fullPath")]=!0,l=j[a];if(SC.typeOf(l)==="function"&&!l.isActionHandler){m=l.apply(j,c),g&&g.call(this,j,m),n+=1;break}j=b(j,"parentState")}}return n===1?m:undefined},_traverseConcurrentStatesToEnter:function(a,b,c,d){var e=0,f=a.length,g=null;for(;e<f;e+=1)g=a[e],g!==b&&this._traverseStatesToEnter(g,null,null,c,d)},_flushPendingStateTransition:function(){if(!this._pendingStateTransitions){this.statechartLogError("Unable to flush pending state transition. _pendingStateTransitions is invalid");return}var a=this._pendingStateTransitions.shift();if(!a)return;this.gotoState(a.state,a.fromCurrentState,a.useHistory,a.context)},_flushPendingSentActions:function(){var a=this._pendingSentActions.shift();return a?this.sendAction(a.action,a.arg1,a.arg2):null},_monitorIsActiveDidChange:function(){b(this,"monitorIsActive")&&SC.none(b(this,"monitor"))&&c(this,"monitor",SC.StatechartMonitor.create())}.observes("monitorIsActive"),_processGotoStateArgs:function(a){var b={state:null,fromCurrentState:null,useHistory:!1,context:null},c=null,d=null;a=Array.prototype.slice.call(a),a=a.filter(function(a){return a!==undefined}),c=a.length;if(c<1)return b;b.state=a[0];if(c===2){d=a[1];switch(SC.typeOf(d)){case"boolean":b.useHistory=d;break;case"object":b.context=d;break;default:b.fromCurrentState=d}}else c===3?(d=a[1],SC.typeOf(d)==="boolean"?(b.useHistory=d,b.context=a[2]):(b.fromCurrentState=d,d=a[2],SC.typeOf(d)==="boolean"?b.useHistory=d:b.context=d)):(b.fromCurrentState=a[1],b.useHistory=a[2],b.context=a[3]);return b},_constructRootStateClass:function(){var a="rootStateExample",c=b(this,a),d=b(this,"initialState"),e=b(this,"statesAreConcurrent"),f=0,g,h,i,j={};SC.typeOf(c)==="function"&&c.statePlugin&&(c=c.apply(this));if(!SC.State.detect(c)||!c.isClass)return this._logStatechartCreationError("Invalid root state example"),null;if(e&&!SC.empty(d))this._logStatechartCreationError("Can not assign an initial state when states are concurrent");else if(e)j.substatesAreConcurrent=!0;else if(SC.typeOf(d)==="string")j.initialSubstate=d;else return this._logStatechartCreationError("Must either define initial state or assign states as concurrent"),null;for(g in this){if(g===a)continue;h=this[g],i=SC.typeOf(h)==="function",i&&h.statePlugin&&(h=h.apply(this)),SC.State.detect(h)&&h.isClass&&this[g]!==this.constructor&&(j[g]=h,f+=1)}return f===0?(this._logStatechartCreationError("Must define one or more states"),null):c.extend(j)},_logStatechartCreationError:function(a){SC.Logger.error("Unable to create statechart for %@: %@.".fmt(this,a))},statechartLogTrace:function(a){SC.Logger.info("%@: %@".fmt(b(this,"statechartLogPrefix"),a))},statechartLogError:function(a){SC.Logger.error("ERROR %@: %@".fmt(b(this,"statechartLogPrefix"),a))},statechartLogWarning:function(a){if(b(this,"suppressStatechartWarnings"))return;SC.Logger.warn("WARN %@: %@".fmt(b(this,"statechartLogPrefix"),a))},statechartLogPrefix:function(){var a=this.constructor.toString(),c=b(this,"name"),d;return SC.empty(c)?d="%@<%@>".fmt(a,SC.guidFor(this)):d="%@<%@, %@>".fmt(a,c,SC.guidFor(this)),d}.property().cacheable(),allowStatechartTracing:function(){var a=b(this,"statechartTraceKey");return b(this,a)}.property().cacheable(),_statechartTraceDidChange:function(){this.notifyPropertyChange("allowStatechartTracing")}},SC.ROOT_STATE_NAME="__ROOT_STATE__",SC.EXIT_STATE=0,SC.ENTER_STATE=1,SC.Statechart=SC.Object.extend(SC.StatechartManager,{autoInitStatechart:!1})}({}),function(a){}({}),function(a){}({})
